{% extends "base.html" %}

{% block title %}Campaign Detail - Google Ads Dashboard{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        background-color: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
        color: var(--primary-color);
    }
    
    .ad-group-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .ad-group-card:hover {
        border-left-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        transform: translateX(5px);
    }
    
    .performance-chart {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .metric-comparison {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
    
    .metric-comparison:last-child {
        border-bottom: none;
    }
    
    .metric-bar {
        height: 6px;
        background-color: #e9ecef;
        border-radius: 3px;
        position: relative;
        margin: 0.5rem 0;
    }
    
    .metric-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .impressions-bar { background-color: var(--primary-color); }
    .clicks-bar { background-color: var(--secondary-color); }
    .cost-bar { background-color: var(--danger-color); }
    
    .back-button {
        margin-bottom: 1rem;
    }
    
    .ad-group-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    .status-enabled .status-indicator { background-color: var(--secondary-color); }
    .status-paused .status-indicator { background-color: var(--warning-color); }
    .status-removed .status-indicator { background-color: var(--danger-color); }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Back Button and Breadcrumb -->
    <div class="col-12">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary back-button">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Campaign {{ campaign_id }}</li>
            </ol>
        </nav>
    </div>
    
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-bullseye text-primary"></i> Ad Groups</h2>
                <p class="text-muted mb-0">Ad groups for Campaign ID: {{ campaign_id }} (Last 30 days)</p>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    
    {% if ad_groups %}
    <!-- Summary Statistics -->
    <div class="col-12">
        <div class="performance-chart">
            <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Campaign Performance Overview</h5>
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="metric-value text-primary">
                            {{ "{:,}".format(ad_groups|sum(attribute='impressions')) }}
                        </div>
                        <div class="metric-label">Total Impressions</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="metric-value text-success">
                            {{ "{:,}".format(ad_groups|sum(attribute='clicks')) }}
                        </div>
                        <div class="metric-label">Total Clicks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="metric-value text-danger">
                            ${{ "%.2f"|format(ad_groups|sum(attribute='cost')) }}
                        </div>
                        <div class="metric-label">Total Cost</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="metric-value text-warning">
                            {% set total_clicks = ad_groups|sum(attribute='clicks') %}
                            {% set total_impressions = ad_groups|sum(attribute='impressions') %}
                            {% if total_impressions > 0 %}
                                {{ "%.2f"|format((total_clicks / total_impressions) * 100) }}%
                            {% else %}
                                0.00%
                            {% endif %}
                        </div>
                        <div class="metric-label">Average CTR</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ad Groups List -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group"></i> Ad Groups ({{ ad_groups|length }})
                </h5>
            </div>
            <div class="card-body">
                {% set max_impressions = ad_groups|max(attribute='impressions') %}
                {% set max_clicks = ad_groups|max(attribute='clicks') %}
                {% set max_cost = ad_groups|max(attribute='cost') %}
                
                <div class="row">
                    {% for ad_group in ad_groups %}
                    <div class="col-lg-6 mb-4">
                        <div class="card ad-group-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title mb-0">{{ ad_group.name }}</h6>
                                    <div class="ad-group-status status-{{ ad_group.status.lower() }}">
                                        <div class="status-indicator"></div>
                                        <span class="badge status-badge status-{{ ad_group.status.lower() }}">
                                            {{ ad_group.status }}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Ad Group ID: {{ ad_group.id }}</small>
                                </div>
                                
                                <!-- Impressions -->
                                <div class="metric-comparison">
                                    <div>
                                        <small class="text-muted">Impressions</small>
                                        <div class="fw-bold">{{ "{:,}".format(ad_group.impressions) }}</div>
                                    </div>
                                    <div style="width: 100px;">
                                        <div class="metric-bar">
                                            <div class="metric-bar-fill impressions-bar" 
                                                 style="width: {% if max_impressions > 0 %}{{ (ad_group.impressions / max_impressions) * 100 }}%{% else %}0%{% endif %}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Clicks -->
                                <div class="metric-comparison">
                                    <div>
                                        <small class="text-muted">Clicks</small>
                                        <div class="fw-bold">{{ "{:,}".format(ad_group.clicks) }}</div>
                                    </div>
                                    <div style="width: 100px;">
                                        <div class="metric-bar">
                                            <div class="metric-bar-fill clicks-bar" 
                                                 style="width: {% if max_clicks > 0 %}{{ (ad_group.clicks / max_clicks) * 100 }}%{% else %}0%{% endif %}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cost -->
                                <div class="metric-comparison">
                                    <div>
                                        <small class="text-muted">Cost</small>
                                        <div class="fw-bold">${{ "%.2f"|format(ad_group.cost) }}</div>
                                    </div>
                                    <div style="width: 100px;">
                                        <div class="metric-bar">
                                            <div class="metric-bar-fill cost-bar" 
                                                 style="width: {% if max_cost > 0 %}{{ (ad_group.cost / max_cost) * 100 }}%{% else %}0%{% endif %}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CTR -->
                                <div class="mt-3 text-center">
                                    <div class="small text-muted">Click-Through Rate</div>
                                    <div class="h5 mb-0 text-success">
                                        {% if ad_group.impressions > 0 %}
                                            {{ "%.2f"|format((ad_group.clicks / ad_group.impressions) * 100) }}%
                                        {% else %}
                                            0.00%
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> Quick Stats Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ad Group</th>
                                <th>Status</th>
                                <th class="text-end">Impressions</th>
                                <th class="text-end">Clicks</th>
                                <th class="text-end">Cost</th>
                                <th class="text-end">CTR</th>
                                <th class="text-end">Avg CPC</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ad_group in ad_groups %}
                            <tr>
                                <td>
                                    <strong>{{ ad_group.name }}</strong>
                                    <br>
                                    <small class="text-muted">ID: {{ ad_group.id }}</small>
                                </td>
                                <td>
                                    <div class="ad-group-status status-{{ ad_group.status.lower() }}">
                                        <div class="status-indicator"></div>
                                        <span class="small">{{ ad_group.status }}</span>
                                    </div>
                                </td>
                                <td class="text-end">{{ "{:,}".format(ad_group.impressions) }}</td>
                                <td class="text-end">{{ "{:,}".format(ad_group.clicks) }}</td>
                                <td class="text-end">${{ "%.2f"|format(ad_group.cost) }}</td>
                                <td class="text-end">
                                    {% if ad_group.impressions > 0 %}
                                        {{ "%.2f"|format((ad_group.clicks / ad_group.impressions) * 100) }}%
                                    {% else %}
                                        0.00%
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if ad_group.clicks > 0 %}
                                        ${{ "%.2f"|format(ad_group.cost / ad_group.clicks) }}
                                    {% else %}
                                        $0.00
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- No Ad Groups Message -->
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-layer-group fa-4x text-muted mb-4"></i>
                <h4>No Ad Groups Found</h4>
                <p class="text-muted mb-4">
                    We couldn't find any ad groups for this campaign in the last 30 days.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item border-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Verify the campaign is active
                            </div>
                            <div class="list-group-item border-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Check if ad groups exist in this campaign
                            </div>
                            <div class="list-group-item border-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Ensure the campaign has received traffic
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshData() {
        const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshBtn.disabled = true;
        
        // Refresh the page after a short delay
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }
    
    // Animate metric bars on page load
    document.addEventListener('DOMContentLoaded', function() {
        const bars = document.querySelectorAll('.metric-bar-fill');
        bars.forEach((bar, index) => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100 + (index * 50));
        });
    });
</script>
{% endblock %}